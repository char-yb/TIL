# Payment System (1)

**결제 시스템의 목표: 사용자의 결제 용청을 성공적으로 처리하여 회사 매출에 기여하는 것**

- 결제 시스템의 기본 구성 요소와 작동 원리
- 신뢰성 있는 결제 시스템을 설계하는 방법
- 결제를 어떻게든 완료시키는 방법
- 결제 데이터의 일관성을 유지하는 방법
- 결제 이벤트 메세지 처리와 전달을 보장하는 방법
- 결제 트랜잭션의 동시성 문제를 제어하는 방법
- Double-Entry Ledger 기반의 시스템을 구축하는 방법

## 결제 시스템의 정의

결제 시스템이란 무엇일까??

“결제 시스템은 금전적 가치를 이동시키는 데에 사용되는 모든 시스템이다. 이에는 그 교환을 가능하게 하는 기관, 도구, 사람, 규칙, 절차, 표준, 기술이 포함된다.”

하지만 여기서 개발하려는 결제 시스템은 아마존이나 쿠팡과 같은 온라인 전자상거래 업체에서 물건을 구매할 때 사용되는 시스템을 구축할 것이다.

## 요구사항 정의

결제 시스템을 만들기 위해 필요한 요구사항들을 구체적으로 정의해보자:

- 결제 옵션 (Payment Option)으로는 여러가지가 있지만 (e.g 신용카드, Paypal, 간편 결제 등), 여기서는 Toss Payments를 이용한 간편 결제만을 다루도록 하자.
- 글로벌 서비스가 아닌 대한민국에서만 서비스를 제공한다는 것을 전제로 하자.
- 결제 서비스가 처리할 수 있는 트래픽의 양은 한 달에 약 1,000,000건으로 설정하자.
즉, 1초에 10건 이상 처리할 수 있어야 한다.
- 사용자 인증이나 보안(Security)과 관련된 요구사항은 생략하도록 하자.
- 결제 시스템은 여러 서비스들의 처리가 필요하다. 고려 사항으로 결제 서비스를 포함한 다른 서비스들 이 장애를 겪더라도 결국에는 결제를 올바르게 완료할 수 있어야 한다. 즉, 신뢰성 (Reliability)과 장애 허용성(Fault Tolerance)이 필요하다.
    - 사용자가 원할 때 언제든 결제 시스템을 이용할 수 있도록, 시스템이 다운되서 이용될 수 없는 상황은 최소로 피해야된다는 것이다.
- 결제 데이터는 일관성(Consistency)이 훼손되어서는 안된다. (e.g 동시성으로 인해 결과가 유실)

## 상위 수준에서 바라본 결제 시스템

![image](https://github.com/user-attachments/assets/df90cd80-2f06-4bc7-9016-befc2e670a6e)

결제 시스템은 기본적으로 두 가지 플로우를 가지고 있다.

- Pay-in 플로우, 이는 구매자가 결제를 진행하고, 그 결제금이 이커머스 법인 계좌로 이체되는 과정을 포함한다.
- Pay-out 플로우, 이는 이커머스 법인 계좌에서 판매자에게 돈을 지불하는 과정을 의미한다.

Pay-out 플로우는 판매자에게 은행을 통해 이체하는 간단한 작업으로, 우리 시스템에서는 별도로 설계하지 않는다. (Pain, Blow에 대한 흐름만 실습해볼 것이다.)

## 결제 시스템에서 필요한 요소들

![image](https://github.com/user-attachments/assets/79f0586a-837f-4395-9d41-5767d112bbcb)

위의 그림은 사용자의 결제 정보를 자사의 서비스에 직접적으로 저장하고, 이를 이용하여 결 제를 진행하는 시스템을 기반으로 결제 시스템에 필요한 요소들을 살펴보려 한다.

그림에 있는 **Payment Event, Payment Service, Payment Order, Payment Executor, Ledger, Wallet**은 모두 개발해야 할 요소들이다.

그러나, 앞으로 개발할 결제 시스템은 이 그림에서 보여진 결제 처리 과정과 약간 다르다. 이 그림은 결제 이벤트 발생 시, Payment Executor가 사용자의 카드 정보 등 결제 정보를 데이터베이스에서 조회하여 PSP에 요청하고 결제가 처리되는 구조를 보여준다.

사용자의 카드 정보와 같은 민감한 정보를 저장하려면 PCI DSS (Payment Card Industry Data Security Standard)라는 엄격한 보안 규칙을 준수해야 한다. 따라서 대부분의 이커머스 업체들은 이 방식을 사용하지 않는다.

또, 우리의 결제 시스템은 PG사와 연계하여 구축될 예정이므로, 결제 처리 과정은 약간 다를 수 있다.

### 해당 이미지에 따른 프로세스 흐름도

1. 결제 요청인 Payment Event 발생되어 결제 처리 진행하여(결제 CTA 또는 Btn 클릭 시 발생) Payment Service(결제의 시작부터 완료까지 전체 과정을 관리)로 전달
2. Payment Event 생성 및 DB 저장 (결제 히스토리 저장)
3. Payment Order - 결제 항목을 의미하고 결제 Item에 대한 상품주문 생성
    1. Order는 Event와 1대 N 관계를 가진다.
4. Payment Executor가 Order를 받아 결제 정보, 카드 정보같은 것들을 가져와 PSP에 전달한다.
5. Ledger 서비스가 결제 승인 후 결제 기록을 저장한다.

**External은 실제 금액 이동 요청이 처리되는 결제 네트워크를 의미**

결제 네트워크 내부에서 실제 금액 이동이 이루어지고, PSP는 결제 중계자 처리, 결제 요청을 받으면 카드 스키마에 전달하여 구매자의 자금을 인출하고 그 금액을 회사 계좌로 이체하는 역할한다.

**Internal은 결제 처리 전/후에 대한 내부 시스템 처리를 의미**

Item에 대한 이벤트가 처리되었으면 판매자에게 얼마를 줘야하는 지, 정산 처리한다.

정산된 결제 금액은 페이 오프로 판매자에게 입금된다.
